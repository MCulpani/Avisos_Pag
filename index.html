<!-- HISTÓRICO -->
<div id="history" class="panel" style="display:none;">
  <h2>Histórico de Arquivos Carregados</h2>
  <p class="small">Aqui são listados os arquivos já processados.</p>

  <div id="historyList" class="list">
    <div class="small">Carregando histórico...</div>
  </div>
</div>

<script>
// Função para verificar se o arquivo já existe no histórico
async function checkIfFileExists(fileName) {
  const uploadsCollection = collection(firestore, "uploads");
  const querySnapshot = await getDocs(query(uploadsCollection, where("fileName", "==", fileName)));
  return !querySnapshot.empty;  // Retorna true se já existe no histórico
}

// Função para salvar no histórico do Firebase
async function saveToHistory(fileName) {
  const uploadsCollection = collection(firestore, "uploads");
  await addDoc(uploadsCollection, {
    fileName: fileName,
    createdAt: new Date()
  });
}

// Função para exibir o histórico na página
async function loadHistory() {
  const uploadsCollection = collection(firestore, "uploads");
  const querySnapshot = await getDocs(query(uploadsCollection, orderBy("createdAt", "desc")));
  const historyList = document.getElementById("historyList");
  
  historyList.innerHTML = "";  // Limpar antes de exibir

  if (querySnapshot.empty) {
    historyList.innerHTML = "<div class='small'>Nenhum arquivo carregado ainda.</div>";
    return;
  }

  querySnapshot.forEach((doc) => {
    const data = doc.data();
    const historyItem = document.createElement("div");
    historyItem.className = "item";
    historyItem.innerHTML = `
      <div class="meta">
        <div style="font-weight:600">${data.fileName}</div>
        <div class="small">${data.createdAt.toDate().toLocaleString()}</div>
      </div>
    `;
    historyList.appendChild(historyItem);
  });
}

// Função para processar os arquivos, incluindo a verificação de duplicação
async function processFiles(files) {
  compiled = [];
  let processed = 0;
  progressContainer.style.display = "block";

  for (const f of files) {
    const fileName = f.name;

    // Verificar se o arquivo já está no histórico
    const exists = await checkIfFileExists(fileName);
    if (exists) {
      console.log(`O arquivo ${fileName} já foi processado. Ignorando...`);
      continue;  // Pula para o próximo arquivo
    }

    const txt = await extractText(f);
    const local = detectLocation(txt);
    const docMatch = txt.match(/Documento\s+(\d{6,})/);
    const documento = docMatch ? docMatch[1] : "";

    const rows = extractRows(txt, local, documento);
    rows.forEach(r => r["Nome da Origem"] = fileName);
    compiled.push(...rows);

    // Salvar no histórico após o processamento
    await saveToHistory(fileName);

    processed++;
    progressBar.style.width = ((processed / files.length) * 100) + "%";
  }

  // Atualizar o dashboard após o processamento
  updateDashboard(compiled);
  renderPreview(compiled);

  progressContainer.style.display = "none";
  downloadBtn.disabled = false;
}

// Chamada para carregar o histórico na primeira vez
loadHistory();
</script>
