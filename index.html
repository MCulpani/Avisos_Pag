<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compilador de Avisos de Pagamento - PDF → Excel</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body { font-family: Arial; margin: 20px; }
    #log { white-space: pre-wrap; background:#f0f0f0; padding:10px; height:200px; overflow-y:auto; }
    table { border-collapse: collapse; margin-top: 15px; }
    table, th, td { border: 1px solid #ccc; padding: 6px; }
</style>
</head>

<body>

<h2>Compilar Avisos de Pagamento (PDF → Excel)</h2>

<input type="file" id="files" multiple accept="application/pdf"><br><br>

<button id="processBtn">Processar e gerar Excel</button>
<button id="downloadBtn" disabled>Baixar Excel</button>

<h3>Status</h3>
<div id="progress"></div>

<h3>Log</h3>
<div id="log"></div>

<h3>Prévia</h3>
<div id="preview"></div>

<script>
// =============== CONFIG PDF WORKER ===============
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

let compiledRows = [];
let workbookBinary = null;

// ====== LOG ======
function log(msg) {
    const now = new Date().toLocaleTimeString();
    document.getElementById("log").textContent =
        `[${now}] ${msg}\n` + document.getElementById("log").textContent;
}

// ====== EXTRAÇÃO DE TEXTO ======
async function extractTextFromPDF(buf) {
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(x => x.str).join(" ") + "\n";
    }
    return text;
}

// ====== PARSER AJUSTADO AOS PDFs (NF preservada) ======
function parseRows(text, origem) {
    const rows = [];

    const regex = /(\d{10,})\s+([0-9\-]+)\s+(\d{2}\.\d{2}\.\d{4})\s+([\d\.,]+)\s+([\d\.,]+)/g;

    let match;
    while ((match = regex.exec(text)) !== null) {
        rows.push({
            SAP: match[1],
            NF: String(match[2]).trim(),  // <<<<<< CORREÇÃO AQUI
            Data: match[3],
            Desconto: match[4].replace(/\./g, "").replace(",", "."),
            Montante: match[5].replace(/\./g, "").replace(",", "."),
            OrigemPDF: origem
        });
    }

    return rows;
}

// ===== PREVIEW =====
function renderPreview(rows) {
    const preview = document.getElementById("preview");

    if (!rows.length) {
        preview.innerHTML = "<p>Nenhuma linha encontrada.</p>";
        return;
    }

    let html = "<table><tr>";
    Object.keys(rows[0]).forEach(k => html += `<th>${k}</th>`);
    html += "</tr>";

    rows.slice(0, 50).forEach(r => {
        html += "<tr>";
        Object.keys(r).forEach(k => html += `<td>${r[k]}</td>`);
        html += "</tr>";
    });

    html += "</table>";
    preview.innerHTML = html;
}

// ===== GERAR EXCEL =====
function buildExcel(rows) {
    const ws = XLSX.utils.json_to_sheet(rows);

    // Forçar NF como texto no Excel
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 1; R <= range.e.r; R++) {
        const cell = ws[`B${R+1}`];
        if (cell) cell.t = "s"; // força string
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    return wb;
}

// ===== PROCESSAR PDFS =====
async function processFiles(files) {
    compiledRows = [];
    document.getElementById("progress").textContent =
        `Processando ${files.length} arquivos...`;

    for (const f of files) {
        log(`Lendo ${f.name}`);

        try {
            const buf = await f.arrayBuffer();
            const text = await extractTextFromPDF(buf);

            const rows = parseRows(text, f.name);
            log(`Linhas encontradas: ${rows.length}`);

            compiledRows.push(...rows);
        } catch (e) {
            log("Erro: " + e.message);
        }
    }

    document.getElementById("progress").textContent =
        `Concluído — Total: ${compiledRows.length} linhas`;
}

// ===== EVENTOS =====
document.getElementById("processBtn").addEventListener("click", async () => {
    const files = [...document.getElementById("files").files];
    if (!files.length) return alert("Selecione PDFs.");

    log("Iniciando processamento...");

    await processFiles(files);
    renderPreview(compiledRows);

    if (compiledRows.length) {
        workbookBinary = buildExcel(compiledRows);
        document.getElementById("downloadBtn").disabled = false;
        log("Excel pronto para download.");
    } else {
        log("Nenhuma linha encontrada.");
    }
});

document.getElementById("downloadBtn").addEventListener("click", () => {
    if (!workbookBinary) return;

    const filename = "compilado.xlsx";
    XLSX.writeFile(workbookBinary, filename);
    log("Arquivo salvo: " + filename);
});
</script>

</body>
</html>
