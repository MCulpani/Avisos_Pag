<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compilar Avisos de Pagamento → Excel</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0; padding:24px; }
    .card { background:#fff; max-width:900px; margin:auto; padding:24px; border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    h1 { margin-top:0; font-size:20px; }
    button { padding:10px 16px; border:0; border-radius:8px; background:#0ea5a4; color:white; cursor:pointer; }
    button[disabled] { opacity:0.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th,td { border-bottom:1px solid #e2e8f0; padding:6px 8px; font-size:13px; }
    #progressContainer { width:100%; background:#e5e7eb; height:14px; border-radius:8px; overflow:hidden; margin-top:16px; }
    #progressBar { height:100%; width:0%; background:#0ea5a4; transition:width .3s; }
  </style>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>

<div class="card">
  <h1>Compilar PDFs de Aviso de Pagamento → Excel</h1>

  <input id="files" type="file" accept="application/pdf" multiple />

  <br><br>
  <button id="processBtn">Processar e gerar Excel</button>
  <button id="downloadBtn" disabled>Baixar Excel</button>

  <div id="progressContainer"><div id="progressBar"></div></div>

  <div id="preview"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const filesInput = document.getElementById("files");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const previewEl = document.getElementById("preview");
const progressBar = document.getElementById("progressBar");

let compiled = [];
let workbookBinary = null;

function updateProgress(pct){
  progressBar.style.width = pct + "%";
}

async function extractText(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  let text = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(x=>x.str).join(" ") + "\n";
  }
  return text;
}

// captura "Documento <número>" (case-insensitive)
function extractDocumento(text){
  const m = text.match(/Documento\s+(\d{6,})/i);
  return m ? m[1] : "";
}

// Regex que aceita NF terminando em números ou 'U'
const rowRegex =
  /(\d{10,})\s+(\d+-(?:\d+|U))\s+(\d{2}\.\d{2}\.\d{4})\s+([\d\.,]+)\s+([\d\.,]+)/g;

function parseCurrency(v){ if(!v) return null; return parseFloat(v.replace(/\./g,"").replace(",", ".")); }
function parseDateBR(d){
  const m = d.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
}
function formatBRL(value){
  if(value == null || isNaN(value)) return "";
  return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function extractRows(text){
  let out = []; let m;
  while((m = rowRegex.exec(text)) !== null){
    out.push({
      "Nº doc SAP": m[1],
      "NF": String(m[2]).trim(),
      "Data": parseDateBR(m[3]),
      "Desconto": parseCurrency(m[4]),
      "Montante bruto": parseCurrency(m[5])
    });
  }
  return out;
}

async function processFiles(files){
  compiled = [];
  const total = files.length;
  for(let i=0;i<total;i++){
    const f = files[i];
    updateProgress(Math.round((i/total)*100));
    const txt = await extractText(f);
    const documento = extractDocumento(txt);
    const rows = extractRows(txt);
    rows.forEach(r => {
      r["Documento"] = documento;
      r["Nome da Origem"] = f.name;
    });
    compiled.push(...rows);
  }
  updateProgress(100);
}

function renderPreview(rows){
  if(!rows.length){ previewEl.innerHTML = "<p>Nenhuma linha encontrada.</p>"; return; }
  const cols = Object.keys(rows[0]);
  let html = "<table><thead><tr>";
  cols.forEach(c => html += `<th>${c}</th>`);
  html += "</tr></thead><tbody>";
  rows.slice(0,50).forEach(r=>{
    html += "<tr>";
    cols.forEach(c => {
      let val = r[c];
      if(c === "Montante bruto" || c === "Desconto") val = formatBRL(val);
      html += `<td>${val ?? ""}</td>`;
    });
    html += "</tr>";
  });
  html += "</tbody></table>";
  if(rows.length > 50) html += `<p>Mostrando 50 de ${rows.length} linhas...</p>`;
  previewEl.innerHTML = html;
}

function buildExcel(rows){
  // ensure column order: Documento first
  const clean = rows.map(r => ({
    "Documento": r["Documento"],
    "Nº doc SAP": r["Nº doc SAP"],
    "NF": r["NF"],
    "Data": r["Data"],
    "Desconto": r["Desconto"],
    "Montante bruto": r["Montante bruto"],
    "Nome da Origem": r["Nome da Origem"]
  }));
  const ws = XLSX.utils.json_to_sheet(clean);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Dados");
  return wb;
}

processBtn.addEventListener("click", async ()=>{
  const files = [...filesInput.files];
  if(!files.length){ alert("Selecione PDFs."); return; }
  processBtn.disabled = true;
  downloadBtn.disabled = true;
  await processFiles(files);
  renderPreview(compiled);
  if(compiled.length){
    workbookBinary = buildExcel(compiled);
    downloadBtn.disabled = false;
  }
  processBtn.disabled = false;
});

downloadBtn.addEventListener("click", ()=>{
  if(!workbookBinary) return;
  const fname = "compilado_" + new Date().toISOString().slice(0,10) + ".xlsx";
  XLSX.writeFile(workbookBinary, fname);
});
</script>

</body>
</html>
