<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversor Aviso de Pagamento</title>

<style>
    body {
        margin: 0;
        padding: 24px;
        font-family: "Inter", Arial, sans-serif;
        background: #f1f5f9;
    }

    /* ===================== LOGIN ===================== */
    #login-area {
        display: none;
    }

    .login-card {
        width: 100%;
        max-width: 380px;
        margin: 60px auto;
        padding: 30px;
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        text-align: center;
    }

    .login-card h2 {
        margin: 0;
        font-size: 26px;
        font-weight: bold;
        color: #0f172a;
    }

    .login-sub {
        margin-top: 4px;
        color: #64748b;
        font-size: 14px;
    }

    .input-group {
        text-align: left;
        margin-top: 18px;
    }

    .input-group label {
        font-size: 14px;
        color: #334155;
    }

    .input-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 15px;
        margin-top: 4px;
    }

    .password-wrapper {
        position: relative;
    }

    .toggle-pass {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 18px;
        opacity: 0.6;
    }

    .toggle-pass:hover {
        opacity: 1;
    }

    .login-btn {
        margin-top: 22px;
        width: 100%;
        background: #0ea5a4 !important;
        padding: 12px;
        border-radius: 8px;
        font-size: 17px;
        color: white;
        cursor: pointer;
        border: none;
    }

    .login-btn:hover {
        background: #0c7c7b !important;
    }

    .login-error {
        margin-top: 12px;
        color: #e11d48;
        font-size: 14px;
    }

    /* ===================== APP ===================== */
    #app-area {
        display: none;
    }

    .card {
        background: #fff;
        max-width: 1100px;
        margin: auto;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h1 {
        margin-top: 0;
        font-size: 26px;
        color: #0f172a;
    }

    /* ===================== BARRA SUPERIOR ===================== */
    .top-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
    }

    .right-actions {
        display: flex;
        gap: 10px;
    }

    /* Estilo geral dos bot√µes */
    button {
        padding: 10px 16px;
        border: 0;
        border-radius: 8px;
        background: #0ea5a4;
        color: white;
        cursor: pointer;
        font-size: 15px;
    }

    button:hover {
        opacity: .9;
    }

    /* Bot√£o Baixar Excel */
    #downloadBtn {
        background: #0ea5a4;
    }

    /* Bot√£o Escolher arquivos */
    #files::-webkit-file-upload-button {
        background: #d1d5db !important;
        color: #111827;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
    }

    /* Bot√£o sair */
    #btnLogout {
        background: #ef4444 !important;
    }

    #btnLogout:hover {
        background: #dc2626 !important;
    }

    /* ===================== PREVIEW ===================== */
    #preview table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
    }

    #preview th, #preview td {
        border-bottom: 1px solid #e2e8f0;
        padding: 6px 8px;
        font-size: 13px;
    }

    /* ===================== PROGRESSO ===================== */
    #progressContainer {
        width: 100%;
        background: #e2e8f0;
        height: 12px;
        border-radius: 6px;
        margin-top: 18px;
        display: none;
    }

    #progressBar {
        height: 100%;
        width: 0%;
        background: #0ea5a4;
        border-radius: 6px;
        transition: width .25s;
    }

    /* ===================== DASHBOARD ===================== */
    #dashboardBox {
        margin-top: 18px;
        padding: 16px;
        background: #fff3cd;
        border: 2px solid #ffca2c;
        border-radius: 8px;
        font-size: 20px;
        font-weight: bold;
        color: #8a6d3b;
    }
</style>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* -----------------------------------------------------
   üî• CONFIG DO FIREBASE ‚Üí COLE A SUA AQUI
----------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyC_FD33WikHRUVCd2JtH_ok3WF1YtfAFhU",
  authDomain: "conversor-de-avisos.firebaseapp.com",
  projectId: "conversor-de-avisos",
  storageBucket: "conversor-de-avisos.firebasestorage.app",
  messagingSenderId: "1099286231450",
  appId: "1:1099286231450:web:94e0b02dec2ef6b0d26223"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* Elementos */
const loginBox = document.getElementById("login-area");
const appBox   = document.getElementById("app-area");

const emailInput = document.getElementById("email");
const passInput  = document.getElementById("password");
const msgLogin   = document.getElementById("login-msg");
const btnLogin   = document.getElementById("btnLogin");
const btnLogout  = document.getElementById("btnLogout");

/* LOGIN */
btnLogin.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value);
    msgLogin.textContent = "";
  } catch (err) {
    msgLogin.textContent = "Erro: " + err.message;
  }
});

/* LOGOUT */
btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

/* PROTE√á√ÉO */
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginBox.style.display = "none";
    appBox.style.display = "block";
  } else {
    loginBox.style.display = "block";
    appBox.style.display = "none";
  }
});
</script>

<!-- Mostrar / Ocultar senha -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("password");
  const toggle = document.getElementById("togglePass");

  toggle.addEventListener("click", () => {
    if (input.type === "password") {
      input.type = "text";
      toggle.textContent = "üôà";
    } else {
      input.type = "password";
      toggle.textContent = "üëÅ";
    }
  });
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>


<!-- ===================== LOGIN ===================== -->
<div id="login-area">
  <div class="login-card">
    <h2>Bem-vindo</h2>
    <p class="login-sub">Fa√ßa login para acessar o sistema</p>

    <div class="input-group">
      <label>Email</label>
      <input id="email" type="email" placeholder="Seu email">
    </div>

    <div class="input-group">
      <label>Senha</label>
      <div class="password-wrapper">
        <input id="password" type="password" placeholder="Sua senha">
        <span id="togglePass" class="toggle-pass">üëÅ</span>
      </div>
    </div>

    <button id="btnLogin" class="login-btn">Entrar</button>
    <p id="login-msg" class="login-error"></p>
  </div>
</div>


<!-- ===================== APP ===================== -->
<div id="app-area">

<div class="card">

  <h1>Conversor de Aviso de Pagamento ‚Ä¢ PDF ‚Üí Excel</h1>

  <div class="top-actions">
      <button id="processBtn">Compilar e Transformar</button>

      <div class="right-actions">
          <button id="downloadBtn" disabled>Baixar Excel</button>
          <button id="btnLogout">Sair da conta</button>
      </div>
  </div>

  <input id="files" type="file" accept="application/pdf" multiple />

  <div id="dashboardBox">Total em Avisos: R$ 0,00</div>

  <div id="progressContainer"><div id="progressBar"></div></div>

  <div id="preview"></div>

</div>

</div> <!-- /app-area -->




<!-- ===================== L√ìGICA ORIGINAL INALTERADA ===================== -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const filesInput = document.getElementById("files");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const previewEl = document.getElementById("preview");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const dashboardBox = document.getElementById("dashboardBox");

let compiled = [];
let workbookBinary = null;

async function extractText(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let text = "";
  for(let i = 1; i <= pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(x => x.str).join(" ") + "\n";
  }
  return text;
}

const LOCATIONS = ["JOINVILLE - SC","CASTRO - PR","CONTAGEM - MG","ESCADA - PE","RIO CLARO - SP","SIMOES FILHO - BA"];

function detectLocation(txt){
  let clean = txt.replace(/\s+/g, ' ').toUpperCase();
  for(const loc of LOCATIONS){
    if(clean.includes(loc)) return loc;
  }
  return "N√ÉO IDENTIFICADO";
}

const rowRegex = /(\d{10,})\s+(\d+-(?:\d+|U))\s+(\d{2}\.\d{2}\.\d{4})\s+([\d.,]+)\s+([\d.,]+)/g;

function parseCurrency(v){ if(!v) return null; return parseFloat(v.replace(/\./g,"").replace(",",".")); }
function parseDateBR(d){ const m = d.match(/(\d{2})\.(\d{2})\.(\d{4})/); return m ? `${m[1]}/${m[2]}/${m[3]}` : ""; }

function getCodigoFilial(local){
  switch(local){
    case "JOINVILLE - SC": return "500001102";
    case "CASTRO - PR": return "500001855";
    case "CONTAGEM - MG": return "500001459";
    case "ESCADA - PE": return "500001122";
    case "RIO CLARO - SP": return "500001131";
    case "SIMOES FILHO - BA": return "500001405";
    default: return "";
  }
}

function extractRows(txt, local, documento){
  let rows = [], m;
  while((m = rowRegex.exec(txt)) !== null){
    rows.push({
      "Local": local,
      "C√≥digo filial": getCodigoFilial(local),
      "Documento": documento,
      "N¬∫ doc SAP": m[1],
      "Doc Refer√™ncia": m[2],
      "Data": parseDateBR(m[3]),
      "Desconto": parseCurrency(m[4]),
      "Montante bruto": parseCurrency(m[5])
    });
  }
  return rows;
}

async function processFiles(files){
  compiled = [];
  let processed = 0;
  progressContainer.style.display = "block";

  for(const f of files){
    const txt = await extractText(f);
    const local = detectLocation(txt);
    const docMatch = txt.match(/Documento\s+(\d{6,})/);
    const documento = docMatch ? docMatch[1] : "";

    const rows = extractRows(txt, local, documento);
    rows.forEach(r => r["Nome da Origem"] = f.name);
    compiled.push(...rows);

    processed++;
    progressBar.style.width = ((processed / files.length) * 100) + "%";
  }
}

function updateDashboard(rows){
  const total = rows.reduce((sum, r) => sum + (r["Montante bruto"] || 0), 0);
  dashboardBox.textContent = "Total em Avisos: " + total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function renderPreview(rows){
  if(!rows.length){
    previewEl.innerHTML = "<p>Nenhum dado encontrado.</p>";
    return;
  }

  const cols = Object.keys(rows[0]);
  let html = "<table><thead><tr>" + cols.map(c => `<th>${c}</th>`).join("") + "</tr></thead><tbody>";

  rows.slice(0,30).forEach(r =>{
    html += "<tr>" + cols.map(c => `<td>${r[c] ?? ""}</td>`).join("") + "</tr>";
  });

  html += "</tbody></table>";
  previewEl.innerHTML = html;
}

function buildExcel(rows){
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Dados");
  return wb;
}

processBtn.addEventListener("click", async () =>{
  const files = [...filesInput.files];
  if(!files.length){ 
    alert("Selecione PDFs.");
    return;
  }

  processBtn.disabled = true;
  downloadBtn.disabled = true;
  progressBar.style.width = "0%";

  await processFiles(files);
  renderPreview(compiled);
  updateDashboard(compiled);

  if(compiled.length){
    workbookBinary = buildExcel(compiled);
    downloadBtn.disabled = false;
  }

  processBtn.disabled = false;
});

downloadBtn.addEventListener("click", ()=>{
  if(!workbookBinary) return;
  XLSX.writeFile(workbookBinary, "compilado_" + new Date().toISOString().slice(0,10) + ".xlsx");
});
</script>

</body>
</html>
