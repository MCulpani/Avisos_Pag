<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conversor PDF → Excel (XLSX) — Compilado Único</title>
  <style>
    body{font-family:Inter, Arial, sans-serif;background:#f5f7fa;color:#0f172a;padding:24px}
    .card{background:white;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);padding:18px;max-width:980px;margin:0 auto}
    h1{font-size:20px;margin:0 0 6px}
    p{margin:6px 0 12px;color:#374151'}
    input[type=file]{display:block;margin-bottom:12px}
    button{background:#2563eb;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .log{font-family:monospace;font-size:13px;white-space:pre-wrap;background:#fff;border-radius:6px;padding:10px;max-height:240px;overflow:auto;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Conversor PDF → Excel (XLSX) — Compilado Único</h1>
    <p>Selecione vários PDFs. O sistema extrai, a partir da linha <strong>N° doc.SAP</strong>, até o próximo marcador (Transporte / Mensagem automática / Página / Total) e gera um único XLSX com o cabeçalho fixo.</p>

    <input id="pdfInput" type="file" accept="application/pdf" multiple />
    <button id="convertBtn">Converter e Baixar XLSX</button>

    <div class="log" id="log">Logs aparecerão aqui...</div>
  </div>

  <!-- Dependências via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <script>
  (function(){
    const logEl = document.getElementById('log');
    function log(){
      try{
        logEl.textContent = (logEl.textContent.trim() ? logEl.textContent + '\\n' : '') + Array.from(arguments).join(' ');
        logEl.scrollTop = logEl.scrollHeight;
      }catch(e){}
    }

    // checagens
    if(typeof XLSX === 'undefined') {
      log('ERRO: Biblioteca XLSX não carregada. Verifique conexão com CDN.');
      return;
    }
    if(typeof pdfjsLib === 'undefined') {
      log('ERRO: Biblioteca pdf.js não carregada. Verifique conexão com CDN.');
      return;
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const input = document.getElementById('pdfInput');
    const btn = document.getElementById('convertBtn');

    // Converte textItems do pdf.js em "linhas" aproximadas usando posição Y e X
    function pageTextToRows(items){
      if(!Array.isArray(items)) return [];
      const pts = items.map(it => {
        const tx = Array.isArray(it.transform) ? it.transform : [1,0,0,1,0,0];
        return { x: tx[4] || 0, y: tx[5] || 0, text: (it.str||'').trim() };
      });
      const buckets = [];
      const Y_THRESHOLD = 3; // ajuste se necessário
      pts.forEach(p => {
        let b = buckets.find(bb => Math.abs(bb.y - p.y) <= Y_THRESHOLD);
        if(!b){
          b = { y: p.y, pts: [] };
          buckets.push(b);
        }
        b.pts.push(p);
      });
      // ordenar de cima para baixo (PDF tem coordenadas específicas)
      buckets.sort((a,b) => b.y - a.y);
      // para cada bucket, ordenar por x e retornar array de textos
      return buckets.map(b => b.pts.sort((u,v)=>u.x-v.x).map(pt => pt.text));
    }

    // Normaliza linhas para ter mesmo número de colunas (preenchendo vazios)
    function normalizeRows(rows){
      if(!rows || rows.length === 0) return [];
      const maxCols = Math.max(...rows.map(r => r.length));
      return rows.map(r => {
        const out = Array.from({length:maxCols}, (_,i) => (r[i]||'').replace(/\s+/g,' ').trim());
        return out;
      });
    }

    // Extrai blocos por página: localiza header "N° doc.SAP" e corta até marcadores finais
    async function extractRowsFromPDF(file){
      log('Abrindo', file.name);
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const collected = [];

      for(let p=1; p<=pdf.numPages; p++){
        try{
          log(' Lendo página', p, 'de', pdf.numPages);
          const page = await pdf.getPage(p);
          const textContent = await page.getTextContent();
          const rowsAll = pageTextToRows(textContent.items || []);

          // Encontrar o índice do cabeçalho "N° doc.SAP" (case-insensitive)
          const headerIndex = rowsAll.findIndex(r => r.some(c => /N° doc\.SAP/i.test(c)));
          if(headerIndex === -1){
            log('  Cabeçalho "N° doc.SAP" não encontrado na página', p);
            continue;
          }

          // cortar do header até marcador final
          let cut = rowsAll.slice(headerIndex);
          const stopMarkers = [/Transporte/i, /Mensagem automática/i, /Página\\s*\\d+/i, /Total:/i];
          const stopIndex = cut.findIndex(r => stopMarkers.some(m => m.test((r||[]).join(' '))));
          if(stopIndex !== -1) cut = cut.slice(0, stopIndex);

          const norm = normalizeRows(cut);
          if(norm.length) collected.push(...norm);
        }catch(e){
          log('  Erro na página', p, ':', e && (e.message || e));
        }
      }

      try{ pdf.destroy(); }catch(e){}
      return collected;
    }

    // Ação do botão: processa todos os arquivos e gera um único XLSX
    btn.addEventListener('click', async () => {
      try{
        const files = Array.from(input.files || []);
        if(files.length === 0){
          alert('Selecione pelo menos um PDF.');
          return;
        }
        btn.disabled = true;
        logEl.textContent = '';
        log('Iniciando conversão de', files.length, 'arquivo(s)...');

        let merged = [];
        for(const f of files){
          const rows = await extractRowsFromPDF(f);
          if(rows && rows.length) merged.push(...rows);
        }

        // filtrar linhas vazias e remover linhas de cabeçalho repetidas (que contenham N° doc.SAP)
        merged = merged.filter(r => r.join('').trim() !== '');
        merged = merged.filter((r, idx) => !(idx > 0 && /N° doc\.SAP/i.test(r.join(' '))));

        // garantir pelo menos 5 colunas por linha (preenche vazios)
        const finalRows = merged.map(r => {
          const out = r.slice(0,5);
          while(out.length < 5) out.push('');
          return out;
        });

        // cabeçalho fixo conforme solicitado
        const header = ['Nº doc.SAP', 'Nº NF', 'Data', 'Desconto', 'Montante bruto'];
        const final = [header, ...finalRows];

        // gerar workbook e forçar download
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(final);
        XLSX.utils.book_append_sheet(wb, ws, 'Mesclado');

        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type:'application/octet-stream'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `compilado-pdfs-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`;
        document.body.appendChild(link);
        link.click();
        link.remove();

        log('Download iniciado:', link.download);
      }catch(e){
        console.error(e);
        log('Erro durante a conversão:', e && (e.message || e));
      }finally{
        btn.disabled = false;
      }
    });

    // feedback ao selecionar arquivos
    input.addEventListener('change', ()=>{ log('Arquivos selecionados:', input.files.length); });

  })();
  </script>
</body>
</html>
