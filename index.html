<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversor de Aviso de Pagamento ‚Äî PDF ‚Üí Excel (SPA)</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --primary:#0ea5a4;
    --primary-2:#14b8a6;
    --muted:#64748b;
    --card-bg:#ffffff;
    --bg:#f0f2f5;
  }
  body{
    margin:0; font-family:'Inter', Arial, sans-serif; background:var(--bg); color:#0f172a;
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--primary-2));
    color:white; padding:18px 22px; display:flex; align-items:center; gap:18px;
    justify-content:space-between;
  }
  header .brand{ font-weight:700; font-size:18px; }
  header .right { display:flex; gap:10px; align-items:center; }
  header button { background:rgba(255,255,255,0.12); color:white; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; }
  .container{ max-width:1100px; margin:30px auto; padding:0 18px; }

  .tabs{ display:flex; gap:12px; margin-bottom:18px; }
  .tab{
    background:var(--card-bg); padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow:0 3px 10px rgba(2,6,23,0.06);
  }
  .tab.active{ outline:3px solid rgba(14,165,164,0.12); transform:translateY(-2px); }

  .panel{
    background:var(--card-bg); padding:22px; border-radius:12px; box-shadow:0 6px 24px rgba(2,6,23,0.06);
  }

  /* layout conversor */
  .row{ display:flex; gap:12px; align-items:center; }
  .col{ flex:1; }
  input[type="file"]{ padding:10px; border-radius:8px; }
  .app-btn{ padding:10px 16px; border:0; border-radius:10px; background:var(--primary); color:white; cursor:pointer; font-weight:600; }
  .app-btn.ghost{ background:#e6eef0; color:#0f172a; }

  #progressContainer{ width:100%; background:#e2e8f0; height:12px; border-radius:6px; margin-top:12px; display:none; }
  #progressBar{ height:100%; width:0%; background:var(--primary); border-radius:6px; transition:width .25s; }

  #preview table { width:100%; border-collapse:collapse; margin-top:18px; font-size:13px; }
  #preview th,#preview td { border-bottom:1px solid #e6eef2; padding:6px 8px; font-size:13px; }
  .dashboard{ margin-top:12px; padding:12px; border-radius:8px; background:#fff8e6; border:1px solid #ffebc2; font-weight:600; color:#7a5b13; }

  /* hist√≥rico */
  .list { margin-top:14px; }
  .item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; background:#fbfcfe; border:1px solid #eef2f6; margin-bottom:8px; }
  .item .meta{ flex:1; }
  .small{ font-size:13px; color:var(--muted); }

  .notice{ margin-top:10px; font-size:14px; color:#065f46; background:#ecfdf5; padding:8px 10px; border-radius:8px; border:1px solid #bbf7d0;}
  .danger{ background:#fff2f2; color:#7a1f1f; border:1px solid #f4c7c7; padding:8px 10px; border-radius:8px; }

  footer{ text-align:center; margin:30px 0; color:var(--muted); font-size:13px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>

<header>
  <div class="brand">Conversor de Avisos ‚Äî PDF ‚Üí Excel (SPA)</div>
  <div class="right">
    <div id="userEmail" class="small"></div>
    <button id="btnLogout" style="display:none;">Sair</button>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div id="tabConverter" class="tab active" onclick="showTab('converter')">üìÑ Conversor</div>
    <div id="tabHistory" class="tab" onclick="showTab('history')">üìÅ Hist√≥rico</div>
  </div>

  <!-- CONVERSOR -->
  <div id="converter" class="panel">
    <!-- login box (mostra s√≥ se n√£o logado) -->
    <div id="loginBox" style="max-width:420px; margin:0 auto 18px auto;">
      <h2 style="margin:0 0 12px 0;">Entrar na Plataforma</h2>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input id="email" type="email" placeholder="Email" style="flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db;">
        <input id="password" type="password" placeholder="Senha" style="flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db;">
      </div>
      <div style="display:flex; gap:8px;">
        <button id="btnLogin" class="app-btn">Entrar</button>
        <button id="btnCreate" class="app-btn ghost">Criar conta</button>
      </div>
      <p id="loginMsg" class="small" style="margin-top:8px;color:#ef4444;"></p>
    </div>

    <!-- app area (aparece s√≥ se logado) -->
    <div id="appArea" style="display:none;">
      <h2>Enviar PDF(s)</h2>

      <div style="margin-top:10px;" class="row">
        <input id="files" type="file" accept="application/pdf" multiple />
        <div style="margin-left:auto;">
          <button id="processBtn" class="app-btn">Compilar e Transformar</button>
          <button id="downloadBtn" class="app-btn" disabled>Baixar Excel</button>
        </div>
      </div>

      <div id="progressContainer"><div id="progressBar"></div></div>

      <div class="dashboard" id="dashboardBox">Total em Avisos: R$ 0,00</div>

      <div id="preview"></div>
    </div>

  </div>

  <!-- HIST√ìRICO -->
  <div id="history" class="panel" style="display:none;">
    <h2>Hist√≥rico de Arquivos Gerados</h2>
    <p class="small">Aqui s√£o listados os arquivos Excel gerados por voc√™.</p>

    <div id="historyList" class="list">
      <div class="small">Carregando hist√≥rico...</div>
    </div>
  </div>

  <footer>Gerado com ‚ù§Ô∏è ‚Äî vers√£o SPA (Conversor + Hist√≥rico)</footer>
</div>

<!-- FIREBASE (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_FD33WikHRUVCd2JtH_ok3WF1YtfAFhU",
    authDomain: "conversor-de-avisos.firebaseapp.com",
    projectId: "conversor-de-avisos",
    storageBucket: "conversor-de-avisos.firebasestorage.app",
    messagingSenderId: "1099286231450",
    appId: "1:1099286231450:web:94e0b02dec2ef6b0d26223"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const firestore = getFirestore(app);
  const storage = getStorage(app);

  const loginBox = document.getElementById("loginBox");
  const appArea = document.getElementById("appArea");
  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const btnLogin = document.getElementById("btnLogin");
  const btnCreate = document.getElementById("btnCreate");
  const loginMsg = document.getElementById("loginMsg");
  const btnLogout = document.getElementById("btnLogout");
  const userEmail = document.getElementById("userEmail");

  /* LOGIN */
  btnLogin.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const pass = passInput.value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      loginMsg.textContent = "";
    } catch (err) {
      loginMsg.textContent = "Erro: " + err.message;
    }
  });

  /* LOGOUT */
  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
  });

  /* PROTE√á√ÉO DO APP */
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginBox.style.display = "none";
      appArea.style.display = "block";
      userEmail.textContent = `Logado como ${user.email}`;
      btnLogout.style.display = "inline-block";
      loadHistory();
    } else {
      loginBox.style.display = "block";
      appArea.style.display = "none";
      btnLogout.style.display = "none";
      userEmail.textContent = '';
    }
  });
</script>

<script>
  // Fun√ß√£o para verificar se o arquivo j√° existe no hist√≥rico
  async function checkIfFileExists(fileName) {
    const uploadsCollection = collection(firestore, "uploads");
    const querySnapshot = await getDocs(query(uploadsCollection, where("fileName", "==", fileName)));
    return !querySnapshot.empty;  // Retorna true se j√° existe no hist√≥rico
  }

  // Fun√ß√£o para salvar no hist√≥rico do Firebase
  async function saveToHistory(fileName) {
    const uploadsCollection = collection(firestore, "uploads");
    await addDoc(uploadsCollection, {
      fileName: fileName,
      createdAt: new Date()
    });
  }

  // Fun√ß√£o para exibir o hist√≥rico na p√°gina
  async function loadHistory() {
    const uploadsCollection = collection(firestore, "uploads");
    const querySnapshot = await getDocs(query(uploadsCollection, orderBy("createdAt", "desc")));
    const historyList = document.getElementById("historyList");

    historyList.innerHTML = "";  // Limpar antes de exibir

    if (querySnapshot.empty) {
      historyList.innerHTML = "<div class='small'>Nenhum arquivo carregado ainda.</div>";
      return;
    }

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const historyItem = document.createElement("div");
      historyItem.className = "item";
      historyItem.innerHTML = `
        <div class="meta">
          <div style="font-weight:600">${data.fileName}</div>
          <div class="small">${data.createdAt.toDate().toLocaleString()}</div>
        </div>
      `;
      historyList.appendChild(historyItem);
    });
  }

  // Fun√ß√£o para processar os arquivos, incluindo a verifica√ß√£o de duplica√ß√£o
  async function processFiles(files) {
    compiled = [];
    let processed = 0;
    progressContainer.style.display = "block";

    for (const f of files) {
      const fileName = f.name;

      // Verificar se o arquivo j√° est√° no hist√≥rico
      const exists = await checkIfFileExists(fileName);
      if (exists) {
        console.log(`O arquivo ${fileName} j√° foi processado. Ignorando...`);
        continue;  // Pula para o pr√≥ximo arquivo
      }

      const txt = await extractText(f);
      const local = detectLocation(txt);
      const docMatch = txt.match(/Documento\s+(\d{6,})/);
      const documento = docMatch ? docMatch[1] : "";

      const rows = extractRows(txt, local, documento);
      rows.forEach(r => r["Nome da Origem"] = fileName);
      compiled.push(...rows);

      // Salvar no hist√≥rico ap√≥s o processamento
      await saveToHistory(fileName);

      processed++;
      progressBar.style.width = ((processed / files.length) * 100) + "%";
    }

    // Atualizar o dashboard ap√≥s o processamento
    updateDashboard(compiled);
    renderPreview(compiled);

    progressContainer.style.display = "none";
    downloadBtn.disabled = false;
  }

  processBtn.addEventListener("click", async () => {
    const files = [...filesInput.files];
    if (!files.length) {
      alert("Selecione PDFs.");
      return;
    }

    processBtn.disabled = true;
    downloadBtn.disabled = true;
    progressBar.style.width = "0%";

    await processFiles(files);
    renderPreview(compiled);
    updateDashboard(compiled);

    if (compiled.length) {
      workbookBinary = buildExcel(compiled);
      downloadBtn.disabled = false;
    }

    processBtn.disabled = false;
  });

  downloadBtn.addEventListener("click", () => {
    if (!workbookBinary) return;
    XLSX.writeFile(workbookBinary, "compilado_" + new Date().toISOString().slice(0, 10) + ".xlsx");
  });
</script>

</body>
</html>
