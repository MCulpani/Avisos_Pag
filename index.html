<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compilar PDFs → Excel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7fafc; padding:24px; }
    .card { background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:900px; margin:auto; }
    button { padding:10px 16px; border:0; background:#0ea5a4; color:white; border-radius:6px; cursor:pointer; }
    button[disabled]{opacity:0.5;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:6px;border-bottom:1px solid #ddd;}
    pre{background:#222;color:#0f0;padding:12px;border-radius:6px;max-height:150px;overflow:auto;}
  </style>
</head>
<body>
<div class="card">
  <h2>Compilar PDFs → Excel (inline version)</h2>
  <input id="files" type="file" accept="application/pdf" multiple />
  <br/>
  <button id="processBtn">Processar e gerar Excel</button>
  <button id="downloadBtn" disabled>Baixar Excel</button>
  <p id="progress"></p>
  <div id="preview"></div>
  <h3>Logs</h3>
  <pre id="log">Pronto.</pre>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// FULL JAVASCRIPT INLINE
const filesInput=document.getElementById("files");
const processBtn=document.getElementById("processBtn");
const downloadBtn=document.getElementById("downloadBtn");
const logEl=document.getElementById("log");
const progressEl=document.getElementById("progress");
const previewEl=document.getElementById("preview");

let compiledRows=[];
let workbookBinary=null;

function log(m){
  logEl.textContent = "["+(new Date().toLocaleTimeString())+"] "+m+"\n"+logEl.textContent;
}

async function extractTextFromPDF(buffer){
  const pdf=await pdfjsLib.getDocument({data:buffer}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const content=await page.getTextContent();
    text+=content.items.map(i=>i.str).join(" ")+"\n";
  }
  return text;
}

function parseCurrency(t){
  if(!t) return null;
  t=t.replace(/[R$\s]/g,"");
  if(t.includes(".") && t.includes(",")) t=t.replace(/\./g,"").replace(",",".");
  else if(t.includes(",")) t=t.replace(",",".");
  t=t.replace(/[^0-9.\-]/g,"");
  const v=parseFloat(t);
  return isNaN(v)?null:v;
}

function parseDateBR(token){
  const m=token.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  return m[3]+"-"+m[2]+"-"+m[1];
}

function parsePdf(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const r=[];
  const regex=/^(\d+)\s+(\S+)\s+(\d{2}\.\d{2}\.\d{4})\s+([\d\.,]+)\s+([\d\.,]+)$/;
  for(const L of lines){
    const m=L.match(regex);
    if(!m) continue;
    if(!m[1].startsWith("5")) continue;
    r.push({
      "Column1.1":parseInt(m[1]),
      "Column1.2":m[2],
      "Column2":parseDateBR(m[3]),
      "Column3":parseCurrency(m[4]),
      "Column4":parseCurrency(m[5]),
      "__line":L
    });
  }
  return r;
}

async function processFiles(files){
  compiledRows=[];
  for(let i=0;i<files.length;i++){
    const f=files[i];
    progressEl.textContent=`Processando ${i+1}/${files.length}: ${f.name}`;
    log("Lendo "+f.name);
    try{
      const buf=await f.arrayBuffer();
      const text=await extractTextFromPDF(buf);
      const rows=parsePdf(text);
      compiledRows.push(...rows.map(r=>({...r,"Nome da Origem":f.name})));
      log("Linhas encontradas: "+rows.length);
    }catch(e){
      log("Erro lendo "+f.name+" → "+e.message);
    }
  }
}

function renderPreview(rows){
  if(rows.length===0){
    previewEl.innerHTML="<p>Nenhuma linha encontrada.</p>";
    return;
  }
  const k=["Nome da Origem","Column1.1","Column1.2","Column2","Column3","Column4"];
  let html="<table><thead><tr>"+k.map(x=>"<th>"+x+"</th>").join("")+"</tr></thead><tbody>";
  rows.slice(0,100).forEach(r=>{
    html+="<tr>"+k.map(x=>"<td>"+(r[x]??"")+"</td>").join("")+"</tr>";
  });
  html+="</tbody></table>";
  previewEl.innerHTML=html;
}

function buildExcel(rows){
  const clean=rows.map(r=>({
    "Nome da Origem":r["Nome da Origem"],
    "Column1.1":r["Column1.1"],
    "Column1.2":r["Column1.2"],
    "Column2":r["Column2"],
    "Column3":r["Column3"],
    "Column4":r["Column4"]
  }));
  const ws=XLSX.utils.json_to_sheet(clean);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Dados");
  return wb;
}

processBtn.onclick=async ()=>{
  const files=[...filesInput.files];
  if(!files.length){alert("Selecione PDFs");return;}
  downloadBtn.disabled=true;
  await processFiles(files);
  renderPreview(compiledRows);
  if(compiledRows.length>0){
    workbookBinary=buildExcel(compiledRows);
    downloadBtn.disabled=false;
    log("Excel pronto.");
  }else{
    log("Nenhuma linha encontrada.");
  }
};

downloadBtn.onclick=()=>{
  XLSX.writeFile(workbookBinary,"compilado.xlsx");
};
</script>
</body>
</html>
