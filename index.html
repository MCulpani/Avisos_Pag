<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversor de Aviso de Pagamento - PDF > Excel</title>

<!-- FONTE MODERNA -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Inter', Arial, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 0;
  }

  /* LOGIN MODERNO */
  #login-area {
    max-width: 400px;
    margin: 6vh auto;
    padding: 50px 30px;
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    text-align: center;
    position: relative;
  }

  #login-area h2 {
    margin-bottom: 32px;
    font-weight: 600;
    color: #0f172a;
    font-size: 26px;
  }

  .input-wrapper {
    position: relative;
    margin-bottom: 20px;
  }

  .input-wrapper input {
    width: 100%;
    padding: 14px 45px 14px 16px;
    font-size: 15px;
    border: 1px solid #cbd5e1;
    border-radius: 12px;
    background: #f8fafc;
    color: #0f172a;
    box-sizing: border-box;
    transition: border 0.3s, box-shadow 0.3s;
  }

  .input-wrapper input:focus {
    border-color: #0ea5a4;
    box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.2);
    outline: none;
  }

  .input-wrapper input::placeholder {
    color: #94a3b8;
  }

  /* √çcones dentro dos inputs */
  .input-wrapper i {
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    font-style: normal;
    color: #64748b;
    cursor: pointer;
    user-select: none;
    font-size: 14px;
  }

  /* BOT√ÉO MODERNO */
  #btnLogin {
    width: 100%;
    padding: 16px;
    font-size: 16px;
    background: linear-gradient(90deg,#0ea5a4,#14b8a6);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
  }

  #btnLogin:hover {
    background: linear-gradient(90deg,#14b8a6,#0ea5a4);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  }

  #login-msg {
    color: #ef4444;
    font-size: 14px;
    margin-top: 14px;
  }

  /* APP */
  .card {
    background:#fff; max-width:1000px; margin:40px auto; padding:24px; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
  }

  button.app-btn {
    padding:10px 16px;
    border:0;
    border-radius:8px;
    background:#0ea5a4;
    color:white;
    cursor:pointer;
  }

  #preview table { width:100%; border-collapse:collapse; margin-top:18px; }
  #preview th,#preview td { border-bottom:1px solid #e2e8f0; padding:6px 8px; font-size:13px; }
  #progressContainer{ width:100%; background:#e2e8f0; height:12px; border-radius:6px; margin-top:18px; display:none; }
  #progressBar{ height:100%; width:0%; background:#0ea5a4; border-radius:6px; transition:width .25s; }
  #dashboardBox{ margin-top:18px; padding:16px; background:#fff3cd; border:2px solid #ffca2c; border-radius:8px; font-size:20px; font-weight:bold; color:#8a6d3b; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<div id="login-area" style="display:block;">
  <h2>Entrar na Plataforma</h2>

  <div class="input-wrapper">
    <input id="email" type="email" placeholder="Email" />
    <i class="user-icon">üë§</i>
  </div>

  <div class="input-wrapper">
    <input id="password" type="password" placeholder="Senha" />
    <i id="togglePassword">üëÅÔ∏è</i>
  </div>

  <button id="btnLogin">Entrar</button>
  <p id="login-msg"></p>
</div>

<!-- APP -->
<div id="app-area" style="display:none;">
  <div class="card">
    <h1>Conversor de Aviso de Pagamento - PDF > Excel</h1>

    <input id="files" type="file" accept="application/pdf" multiple />
    <br><br>

    <!-- BOT√ïES: Compilar | Baixar Excel | Logout -->
    <div style="display:flex; align-items:center; gap:10px; margin-top:16px;">
      <button id="processBtn" class="app-btn">Compilar e Transformar</button>
      <button id="downloadBtn" class="app-btn" disabled>Baixar Excel</button>
      <div style="margin-left:auto;">
        <button id="btnLogout" class="app-btn" style="background:#ff5252;">Sair da conta</button>
      </div>
    </div>

    <div id="dashboardBox">Total em Avisos: R$ 0,00</div>

    <div id="progressContainer"><div id="progressBar"></div></div>

    <div id="preview"></div>
  </div>
</div>

<!-- HIST√ìRICO -->
<div id="history" class="panel" style="display:none;">
  <h2>Hist√≥rico de Arquivos Carregados</h2>
  <p class="small">Aqui s√£o listados os arquivos j√° processados.</p>

  <div id="historyList" class="list">
    <div class="small">Carregando hist√≥rico...</div>
  </div>
</div>

<!-- FIREBASE AUTH -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_FD33WikHRUVCd2JtH_ok3WF1YtfAFhU",
  authDomain: "conversor-de-avisos.firebaseapp.com",
  projectId: "conversor-de-avisos",
  storageBucket: "conversor-de-avisos.firebasestorage.app",
  messagingSenderId: "1099286231450",
  appId: "1:1099286231450:web:94e0b02dec2ef6b0d26223"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const loginBox = document.getElementById("login-area");
const appBox   = document.getElementById("app-area");
const msgLogin = document.getElementById("login-msg");

const emailInput = document.getElementById("email");
const passInput  = document.getElementById("password");
const btnLogin   = document.getElementById("btnLogin");
const btnLogout  = document.getElementById("btnLogout");

/* LOGIN */
btnLogin.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const pass  = passInput.value;

  try {
    await signInWithEmailAndPassword(auth, email, pass);
    msgLogin.textContent = "";
  } catch (err) {
    msgLogin.textContent = "Erro: " + err.message;
  }
});

/* LOGOUT */
btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

/* PROTE√á√ÉO DO APP */
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginBox.style.display = "none";
    appBox.style.display = "block";
    loadHistory();
  } else {
    loginBox.style.display = "block";
    appBox.style.display = "none";
  }
});
</script>

<!-- APP SCRIPT -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const filesInput = document.getElementById("files");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const previewEl = document.getElementById("preview");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const dashboardBox = document.getElementById("dashboardBox");

let compiled = [];
let workbookBinary = null;

async function extractText(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let text = "";
  for(let i = 1; i <= pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(x => x.str).join(" ") + "\n";
  }
  return text;
}

const LOCATIONS = [
  "JOINVILLE - SC","CASTRO - PR","CONTAGEM - MG",
  "ESCADA - PE","RIO CLARO - SP","SIMOES FILHO - BA"
];

function detectLocation(txt){
  let clean = txt.replace(/\s+/g, ' ').toUpperCase();
  for(const loc of LOCATIONS){
    if(clean.includes(loc)) return loc;
  }
  return "N√ÉO IDENTIFICADO";
}

const rowRegex =
  /(\d{10,})\s+(\d+-(?:\d+|U))\s+(\d{2}\.\d{2}\.\d{4})\s+([\d.,]+)\s+([\d.,]+)/g;

function parseCurrency(v){
  if(!v) return null;
  return parseFloat(v.replace(/\./g,"").replace(",","."));
}

function parseDateBR(d){
  const m = d.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : "";
}

function getCodigoFilial(local){
  switch(local){
    case "JOINVILLE - SC": return "500001102";
    case "CASTRO - PR": return "500001855";
    case "CONTAGEM - MG": return "500001459";
    case "ESCADA - PE": return "500001122";
    case "RIO CLARO - SP": return "500001131";
    case "SIMOES FILHO - BA": return "500001405";
    default: return "";
  }
}

function extractRows(txt, local, documento){
  let rows = [], m;
  while((m = rowRegex.exec(txt)) !== null){
    rows.push({
      "Local": local,
      "C√≥digo filial": getCodigoFilial(local),
      "Documento": documento,
      "N¬∫ doc SAP": m[1],
      "Doc Refer√™ncia": m[2],
      "Data": parseDateBR(m[3]),
      "Desconto": parseCurrency(m[4]),
      "Montante bruto": parseCurrency(m[5])
    });
  }
  return rows;
}

// Fun√ß√£o para verificar se o arquivo j√° existe no hist√≥rico
async function checkIfFileExists(fileName) {
  const uploadsCollection = collection(firestore, "uploads");
  const querySnapshot = await getDocs(query(uploadsCollection, where("fileName", "==", fileName)));
  return !querySnapshot.empty;  // Retorna true se j√° existe no hist√≥rico
}

// Fun√ß√£o para salvar no hist√≥rico do Firebase
async function saveToHistory(fileName) {
  const uploadsCollection = collection(firestore, "uploads");
  await addDoc(uploadsCollection, {
    fileName: fileName,
    createdAt: new Date()
  });
}

// Fun√ß√£o para exibir o hist√≥rico na p√°gina
async function loadHistory() {
  const uploadsCollection = collection(firestore, "uploads");
  const querySnapshot = await getDocs(query(uploadsCollection, orderBy("createdAt", "desc")));
  const historyList = document.getElementById("historyList");
  
  historyList.innerHTML = "";  // Limpar antes de exibir

  if (querySnapshot.empty) {
    historyList.innerHTML = "<div class='small'>Nenhum arquivo carregado ainda.</div>";
    return;
  }

  querySnapshot.forEach((doc) => {
    const data = doc.data();
    const historyItem = document.createElement("div");
    historyItem.className = "item";
    historyItem.innerHTML = `
      <div class="meta">
        <div style="font-weight:600">${data.fileName}</div>
        <div class="small">${data.createdAt.toDate().toLocaleString()}</div>
      </div>
    `;
    historyList.appendChild(historyItem);
  });
}

// Fun√ß√£o para processar os arquivos, incluindo a verifica√ß√£o de duplica√ß√£o
async function processFiles(files) {
  compiled = [];
  let processed = 0;
  progressContainer.style.display = "block";

  for (const f of files) {
    const fileName = f.name;

    // Verificar se o arquivo j√° est√° no hist√≥rico
    const exists = await checkIfFileExists(fileName);
    if (exists) {
      console.log(`O arquivo ${fileName} j√° foi processado. Ignorando...`);
      continue;  // Pula para o pr√≥ximo arquivo
    }

    const txt = await extractText(f);
    const local = detectLocation(txt);
    const docMatch = txt.match(/Documento\s+(\d{6,})/);
    const documento = docMatch ? docMatch[1] : "";

    const rows = extractRows(txt, local, documento);
    rows.forEach(r => r["Nome da Origem"] = fileName);
    compiled.push(...rows);

    // Salvar no hist√≥rico ap√≥s o processamento
    await saveToHistory(fileName);

    processed++;
    progressBar.style.width = ((processed / files.length) * 100) + "%";
  }

  // Atualizar o dashboard ap√≥s o processamento
  updateDashboard(compiled);
  renderPreview(compiled);

  progressContainer.style.display = "none";
  downloadBtn.disabled = false;
}

// Fun√ß√£o para renderizar os dados e evitar duplica√ß√£o
processBtn.addEventListener("click", async () =>{
  const files = [...filesInput.files];
  if(!files.length){
    alert("Selecione PDFs.");
    return;
  }

  processBtn.disabled = true;
  downloadBtn.disabled = true;
  progressBar.style.width = "0%";

  await processFiles(files);
  renderPreview(compiled);
  updateDashboard(compiled);

  if(compiled.length){
    workbookBinary = buildExcel(compiled);
    downloadBtn.disabled = false;
  }

  processBtn.disabled = false;
});

downloadBtn.addEventListener("click", ()=>{
  if(!workbookBinary) return;
  XLSX.writeFile(
    workbookBinary,
    "compilado_" + new Date().toISOString().slice(0,10) + ".xlsx"
  );
});
</script>

</body>
</html>
