<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Processar Avisos de Pagamento</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<!-- SheetJS (Excel) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
}
.container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
}
button {
    padding: 12px 20px;
    background: #0066ff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 20px;
}
button:hover {
    background: #0044aa;
}
.log-box {
    margin-top: 20px;
    padding: 15px;
    background: #111;
    color: #0f0;
    height: 300px;
    overflow-y: auto;
    font-family: monospace;
    white-space: pre-wrap;
    border-radius: 5px;
}
</style>
</head>

<body>
<div class="container">
    <h2>Processador de Avisos de Pagamento</h2>

    <p>Selecione os PDFs:</p>
    <input type="file" id="pdfs" accept="application/pdf" multiple />

    <button onclick="processarPDFs()">Processar e gerar Excel</button>

    <div class="log-box" id="log"></div>
</div>

<script>
function log(msg) {
    document.getElementById("log").textContent += msg + "\n";
}

async function extractTextFromPDF(file) {
    log(`üìÑ Lendo ${file.name}`);

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    let fullText = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(s => s.str);
        fullText += strings.join(" ") + "\n";
    }

    return fullText;
}

async function processarPDFs() {
    const input = document.getElementById("pdfs");
    if (!input.files.length) {
        alert("Selecione arquivos PDF");
        return;
    }

    log("üîç Iniciando leitura...");

    const rows = [];

    const regex = /(5\d{9})\s+(\d{9}-\d{3})\s+(\d{2}\.\d{2}\.\d{4})\s+([\d\.,]+)\s+([\d\.,]+)/g;

    for (const pdf of input.files) {
        const text = await extractTextFromPDF(pdf);

        let matchCount = 0;
        let match;
        while ((match = regex.exec(text)) !== null) {
            matchCount++;
            rows.push({
                SAP: match[1],
                NF: match[2],
                Data: match[3],
                Desconto: match[4].replace(".", "").replace(",", "."),
                Montante: match[5].replace(".", "").replace(",", "."),
                OrigemPDF: pdf.name
            });
        }

        log(`‚úî ${matchCount} linhas extra√≠das de ${pdf.name}\n`);
    }

    if (rows.length === 0) {
        log("‚ùå Nenhuma linha encontrada. Verifique os PDFs.");
        alert("Nenhuma linha v√°lida foi encontrada!");
        return;
    }

    log(`Total final de linhas: ${rows.length}`);

    gerarExcel(rows);
}

function gerarExcel(rows) {
    log("üì¶ Gerando Excel...");

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");

    const data = XLSX.write(wb, { bookType: "xlsx", type: "array" });

    const blob = new Blob([data], { type: "application/octet-stream" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "avisos_pagamento.xlsx";
    a.click();

    URL.revokeObjectURL(url);

    log("üéâ Excel gerado com sucesso!");
}
</script>
</body>
</html>
