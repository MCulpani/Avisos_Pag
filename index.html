<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compilar Avisos de Pagamento → Excel</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0; padding:24px; }
    .card { background:#fff; max-width:900px; margin:auto; padding:24px; border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    h1 { margin-top:0; font-size:20px; }
    button { padding:10px 16px; border:0; border-radius:8px; background:#0ea5a4; color:white; cursor:pointer; }
    button[disabled] { opacity:0.6; cursor:not-allowed; }
    #log { background:#0f172a; color:#d1fae5; padding:12px; border-radius:6px; height:200px; overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th,td { border-bottom:1px solid #e2e8f0; padding:6px 8px; font-size:13px; }
  </style>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>

<div class="card">
  <h1>Compilar PDFs de Aviso de Pagamento → Excel</h1>

  <input id="files" type="file" accept="application/pdf" multiple />

  <br><br>
  <button id="processBtn">Processar e gerar Excel</button>
  <button id="downloadBtn" disabled>Baixar Excel</button>

  <h3>Logs</h3>
  <pre id="log">Pronto.</pre>

  <div id="preview"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const filesInput = document.getElementById("files");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const logEl = document.getElementById("log");
const previewEl = document.getElementById("preview");

let compiled = [];
let workbookBinary = null;

function log(msg){
  logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
}

async function extractText(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;

  let text = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(x=>x.str).join(" ") + "\n";
  }
  return text;
}

// Regex incluindo final -U
const locations = ["JOINVILLE - SC","CASTRO - PR","CONTAGEM - MG","ESCADA - PE","RIO CLARO - SP","SIMOES FILHO - BA"];
function detectLocation(text){
  for(const loc of locations){ if(text.includes(loc)) return loc; }
  return "";
}

const rowRegex =
  /(\d{10,})\s+(\d+-(?:\d+|U))\s+(\d{2}\.\d{2}\.\d{4})\s+([\d\.,]+)\s+([\d\.,]+)/g;

function parseCurrency(v){
  if(!v) return null;
  let t = v.replace(/\./g,"").replace(",",".");
  return parseFloat(t);
}

function parseDateBR(d){
  const m = d.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  if(!m) return null;
  return `${m[1]}/${m[2]}/${m[3]}`; // <-- agora com /
}

function formatBRL(value){
  if(value == null || isNaN(value)) return "";
  return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

// Detectar LOCAL no PDF
const LOCATIONS = ["JOINVILLE - SC","CASTRO - PR","CONTAGEM - MG","ESCADA - PE","RIO CLARO - SP","SIMOES FILHO - BA"];
function detectLocation(txt){
  for(const L of LOCATIONS){ if(txt.includes(L)) return L; }
  return "";
}

function extractRows(text, location){
  let out = [];
  let m;
  const local = detectLocation(text);
  while((m = rowRegex.exec(text)) !== null){
    out.push({
      "Local": local,
      "Local": location,
      "Nº doc SAP": m[1],
      "NF": m[2],
      "Data": parseDateBR(m[3]), // <-- agora com barra
      "Desconto": parseCurrency(m[4]),
      "Montante bruto": parseCurrency(m[5])
    });
  }
  return out;
}

async function processFiles(files){
  compiled = [];

  for(const f of files){
    log(`Lendo ${f.name} ...`);
    const txt = await extractText(f);

    // Detectar LOCAL
    let local = "";
    const locais = [
      "JOINVILLE - SC",
      "CASTRO - PR",
      "CONTAGEM - MG",
      "ESCADA - PE",
      "RIO CLARO - SP",
      "SIMOES FILHO - BA"
    ];
    for(const L of locais){
      if(txt.includes(L)){ local = L; break; }
    }

    // Extrair linhas
    const rows = extractRows(txt, local);
    log(`Linhas encontradas: ${rows.length}`);

    // Completar metadados corretamente
    rows.forEach(r => {
  r["Local"] = local;
  r["Nome da Origem"] = f.name;
});

compiled.push(...rows);
  }

  if(!compiled.length){
    log("Nenhuma linha foi encontrada.");
  }
}){
    log("Nenhuma linha foi encontrada.");
  }
}

function renderPreview(rows){
  if(!rows.length){
    previewEl.innerHTML = "<p>Nenhuma linha encontrada.</p>";
    return;
  }

  const cols = Object.keys(rows[0]);
  let html = "<table><thead><tr>";

  cols.forEach(c => html += `<th>${c}</th>`);
  html += "</tr></thead><tbody>";

  rows.slice(0,50).forEach(r=>{
    html += "<tr>";
    cols.forEach(c => {
      let val = r[c];
      if(c === "Montante bruto" || c === "Desconto"){
        val = formatBRL(val);
      }
      html += `<td>${val ?? ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";

  if(rows.length > 50)
    html += `<p>Mostrando 50 de ${rows.length} linhas...</p>`;

  previewEl.innerHTML = html;
}

function buildExcel(rows){
  const exportRows = rows.map(r => ({
    ...r,
    "Desconto": r["Desconto"],
    "Montante bruto": r["Montante bruto"]
  }));

  const ws = XLSX.utils.json_to_sheet(exportRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Dados");
  return wb;
}

processBtn.addEventListener("click", async ()=>{
  const files = [...filesInput.files];

  if(!files.length){
    alert("Selecione PDFs.");
    return;
  }

  processBtn.disabled = true;
  downloadBtn.disabled = true;

  log("Processando...");

  await processFiles(files);
  renderPreview(compiled);

  if(compiled.length){
    workbookBinary = buildExcel(compiled);
    downloadBtn.disabled = false;
    log("Excel pronto para download.");
  }

  processBtn.disabled = false;
});

downloadBtn.addEventListener("click", ()=>{
  if(!workbookBinary) return;

  const fname = "compilado_" + new Date().toISOString().slice(0,10) + ".xlsx";
  XLSX.writeFile(workbookBinary, fname);
  log("Download realizado: " + fname);
});
</script>

</body>
</html>
